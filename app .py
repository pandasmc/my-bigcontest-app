import streamlit as st
import pandas as pd
import google.generativeai as genai
import warnings

# ê²½ê³  ë©”ì‹œì§€ ë¬´ì‹œ
warnings.filterwarnings('ignore')

# ----------------------------------------------------------------------
# í˜ì´ì§€ ê¸°ë³¸ ì„¤ì •
# ----------------------------------------------------------------------
st.set_page_config(
    page_title="ë‚´ ê°€ê²Œë¥¼ ì‚´ë¦¬ëŠ” AI ë¹„ë°€ìƒë‹´ì‚¬",
    page_icon="ğŸ’¡",
    layout="wide",
)

# ----------------------------------------------------------------------
# 1. êµ°ì§‘ í•´ì„¤ì§‘ (ë”•ì…”ë„ˆë¦¬) - (ì‚¬ìš©ì ìµœì¢… ë¶„ì„ ê²°ê³¼ ë°˜ì˜)
# ----------------------------------------------------------------------
# (ì¤‘ìš”!) êµ°ì§‘ ë²ˆí˜¸(0, 1, 2...)ì™€ ì‚¬ìš©ìë‹˜ì˜ ë¶„ì„ ë‚´ìš©ì´
# ì •í™•íˆ ì¼ì¹˜í•˜ëŠ”ì§€ ì—‘ì…€/ë¶„ì„í‘œë¥¼ ë³´ê³  ë‹¤ì‹œ í•œë²ˆ í™•ì¸/ìˆ˜ì •í•˜ì„¸ìš”.

# ê³ ê° ìœ í˜• (WHO) êµ°ì§‘ (K=6ìœ¼ë¡œ ê°€ì •)
WHO_CLUSTER_DESCRIPTIONS = {
    0.0: "30-50ëŒ€ ë‚¨ì„± ì¤‘ì‹¬ êµ°ì§‘ (ë‚¨ì„± 30-60ëŒ€ê°€ ë§ì´ì˜´, ì—¬ì„± 20-30ëŒ€ê°€ ê°€ì¥ ì ìŒ)",
    1.0: "50-60ëŒ€ ê³ ì—°ë ¹ì¸µ ì¤‘ì‹¬ êµ°ì§‘ (ë‚¨ì„± 50-60ëŒ€, ì—¬ì„± 50-60ëŒ€ ë¹„ì¤‘ì´ ë†’ìŒ)",
    2.0: "ë¹„êµì  ëª¨ë“  ê³ ê°ì´ ê³ ë¥´ê²Œ ë¶„í¬ëœ êµ°ì§‘",
    3.0: "ë‚¨ì„± 50-60ëŒ€ ì´ˆê³ ë ¹ì¸µ ì¤‘ì‹¬ êµ°ì§‘ (ë‹¤ë¥¸ ëª¨ë“  ê³ ê°ì¸µ ë¹„ì¤‘ì´ íŠ¹íˆ ë‚®ìŒ)",
    4.0: "20-30ëŒ€ ì Šì€ ì¸µ ì¤‘ì‹¬ êµ°ì§‘ (ë‚¨ì„± 20ëŒ€/ì—¬ì„± 20-30ëŒ€ ë§ìŒ, 40-60ëŒ€ ê±°ì˜ ì—†ìŒ)",
    5.0: "ë‚¨ì„± 20-30ëŒ€, ì—¬ì„± 30ëŒ€ ë¹„ìœ¨ì´ ë¹„êµì  ë†’ìŒ"
}

# ê°€ê²Œ ê²½ìŸë ¥ (SIZE) êµ°ì§‘ (K=3)
SIZE_CLUSTER_DESCRIPTIONS = {
    0.0: "ê²½ìŸë ¥ 'í•˜' ê·¸ë£¹ (ë‹¤ ë‚®ì€ í¸ì¸ë° ë§¤ì¶œìˆœìœ„ë¹„ìœ¨ 0.1 í‰ê· )",
    1.0: "ê²½ìŸë ¥ 'ìµœìƒ(1ë“±)' ê·¸ë£¹ (ë§¤ì¶œ, ê³ ê°, ìˆœìœ„ ëª¨ë‘ 1ë“±)",
    2.0: "ê²½ìŸë ¥ 'ì¤‘ìœ„ê¶Œ' ê·¸ë£¹"
}

# ê³ ê° ê´€ê³„ (LOYALTY) êµ°ì§‘ (K=4ë¡œ ê°€ì •)
LOYALTY_CLUSTER_DESCRIPTIONS = {
    0.0: "ê³ ê° ì´íƒˆí˜• (ì¬ë°©ë¬¸, ì‹ ê·œ ëª¨ë‘ ë‚®ìŒ, 1ì ëŒ€)",
    1.0: "ë°¸ëŸ°ìŠ¤í˜• (ì¬ë°©ë¬¸, ì‹ ê·œ ëª¨ë‘ ë³´í†µ, 3ì ëŒ€)",
    2.0: "ì‹ ê·œ ìœ ì…í˜• (ì‹ ê·œê°€ ì¬ë°©ë¬¸ë³´ë‹¤ ë†’ìŒ)",
    3.0: "ì¶©ì„± ë‹¨ê³¨í˜• (ì¬ë°©ë¬¸ì´ ì‹ ê·œë³´ë‹¤ ë†’ìŒ)"
}

# ----------------------------------------------------------------------
# 2. ë°ì´í„° ë¡œë“œ
# ----------------------------------------------------------------------
@st.cache_data
def load_data(filepath):
    """ëª¨ë“  êµ°ì§‘ ë¶„ì„ì´ ì™„ë£Œëœ ìµœì¢… ë°ì´í„° íŒŒì¼ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤."""
    try:
        df = pd.read_csv(filepath)
        return df
    except FileNotFoundError:
        st.error(f"ì˜¤ë¥˜: '{filepath}' íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        st.info(f"'{filepath}' íŒŒì¼ì´ app.pyì™€ ë™ì¼í•œ í´ë”ì— ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.")
        return None

# --- ë°ì´í„° ë¡œë“œ ì‹¤í–‰ ---
data = load_data("ìµœì¢…ë°ì´í„°.csv")

# ----------------------------------------------------------------------
# 3. Gemini í”„ë¡¬í”„íŠ¸ ìƒì„± í•¨ìˆ˜
# ----------------------------------------------------------------------
def generate_prompt(store_name, industry, open_date, close_date, who_desc, size_desc, loyalty_desc):
    """3ê°€ì§€ êµ°ì§‘ ì„¤ëª…ì„ ëª¨ë‘ í¬í•¨í•˜ì—¬ Gemini í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤."""
    close_info = "í˜„ì¬ ìš´ì˜ ì¤‘" if pd.isna(close_date) else f"íì—…ì¼: {close_date}"
    prompt = f"""
ë‹¹ì‹ ì€ ëŒ€í•œë¯¼êµ­ ì†Œìƒê³µì¸ì„ ìœ„í•œ ìµœê³ ì˜ AI ì „ëµ ì»¨ì„¤í„´íŠ¸ì…ë‹ˆë‹¤.
ì§€ê¸ˆë¶€í„° ë‚´ê°€ ì œê³µí•˜ëŠ” [ê°€ë§¹ì  ê¸°ë³¸ ì •ë³´]ì™€ [3ì°¨ì› ì…ì²´ ë¶„ì„ ê²°ê³¼]ë¥¼ ê¸°ë°˜ìœ¼ë¡œ,
{store_name} ì‚¬ì¥ë‹˜ì„ ìœ„í•œ ë§ì¶¤í˜• ì „ëµ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

[ê°€ë§¹ì  ê¸°ë³¸ ì •ë³´]
- ê°€ë§¹ì ëª…: {store_name}
- ì—…ì¢…: {industry}
- ê°œì„¤ì¼: {open_date}
- {close_info}

[3ì°¨ì› ì…ì²´ ë¶„ì„ ê²°ê³¼]
1. ê³ ê° ìœ í˜• (WHO): {who_desc}
2. ê°€ê²Œ ê²½ìŸë ¥ (SIZE): {size_desc}
3. ê³ ê° ê´€ê³„ (LOYALTY): {loyalty_desc}

[ë¦¬í¬íŠ¸ ì‘ì„± ê°€ì´ë“œë¼ì¸]
1. ìœ„ 3ê°€ì§€ ë¶„ì„ ê²°ê³¼ë¥¼ ì¢…í•©ì ìœ¼ë¡œ ê³ ë ¤í•˜ì—¬, ì‚¬ì¥ë‹˜ì´ ì§€ê¸ˆ ë‹¹ì¥ ì‹¤í–‰í•´ì•¼ í•  ê°€ì¥ ì¤‘ìš”í•˜ê³  ì°½ì˜ì ì¸ 'í•µì‹¬ ì•¡ì…˜ í”Œëœ 1ê°€ì§€'ë¥¼ ì œì•ˆí•´ì£¼ì„¸ìš”.
2. í•´ë‹¹ ì•¡ì…˜ í”Œëœì„ ì‹¤í–‰í–ˆì„ ë•Œì˜ 'ì˜ˆìƒ ê¸°ëŒ€íš¨ê³¼'ë¥¼ êµ¬ì²´ì ì¸ ìˆ˜ì¹˜ë¥¼ í¬í•¨í•˜ì—¬ ì œì‹œí•´ì£¼ì„¸ìš”.
3. ì „ì²´ì ì¸ í†¤ì€ ì‚¬ì¥ë‹˜ê»˜ ì§ì ‘ ì¡°ì–¸í•˜ëŠ” ê²ƒì²˜ëŸ¼ ì¹œì ˆí•˜ê³ , ê²©ë ¤í•˜ë©°, ì´í•´í•˜ê¸° ì‰¬ìš´ ìš©ì–´ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.
4. ë¦¬í¬íŠ¸ì˜ ë§ˆì§€ë§‰ì—ëŠ” ì‘ì›ì˜ ë©”ì‹œì§€ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.
"""
    return prompt.strip()

# ----------------------------------------------------------------------
# 4. Streamlit í™”ë©´ êµ¬ì„± (ë©”ì¸ ë¡œì§)
# ----------------------------------------------------------------------

if data is None:
    st.stop()

st.title("ğŸ’¡ ë‚´ ê°€ê²Œë¥¼ ì‚´ë¦¬ëŠ” AI ë¹„ë°€ìƒë‹´ì‚¬")
st.caption("ê°€ë§¹ì ë³„ 3ì°¨ì› ì…ì²´ ì§„ë‹¨ ë° ë§ì¶¤ ì „ëµ ì œì•ˆ")

# --- ê°€ë§¹ì  ê²€ìƒ‰ ë° ì„ íƒ ---
search = st.text_input("ğŸ” ê°€ë§¹ì ëª…ì„ ì…ë ¥í•˜ì—¬ ê²€ìƒ‰í•˜ì„¸ìš” (ì˜ˆ: 'Aí”ŒëŸ¬ìŠ¤ ì‹ë‹¹')", "")

filtered = data[data['ê°€ë§¹ì ëª…'].astype(str).str.contains(search, case=False, na=False)] if search else data.head(100)

if not filtered.empty:
    selected = st.selectbox("ê°€ë§¹ì ì„ ì„ íƒí•˜ì„¸ìš”", filtered['ê°€ë§¹ì ëª…'].unique())
    store_data = data[data['ê°€ë§¹ì ëª…'] == selected].iloc[0]

    # --- 3ê°€ì§€ êµ°ì§‘ ë²ˆí˜¸ ë° í…ìŠ¤íŠ¸ ì„¤ëª… ê°€ì ¸ì˜¤ê¸° (í•µì‹¬ ê²°í•© ë¡œì§) ---
    try:
        # (ì¤‘ìš”!) final_master_data.csvì— ì €ì¥ëœ "êµ°ì§‘ ì»¬ëŸ¼ëª…"ê³¼ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
        who_num = store_data.get('êµ°ì§‘_ê³ ê°ìœ í˜•_KM', None)
        size_num = store_data.get('êµ°ì§‘_ê°€ê²Œê²½ìŸë ¥_KM', None)
        loyalty_num = store_data.get('êµ°ì§‘_ê³ ê°ê´€ê³„_KM', None)

        who_desc = WHO_CLUSTER_DESCRIPTIONS.get(who_num, f"ë¶„ì„ì¤‘ (êµ°ì§‘ë²ˆí˜¸: {who_num})")
        size_desc = SIZE_CLUSTER_DESCRIPTIONS.get(size_num, f"ë¶„ì„ì¤‘ (êµ°ì§‘ë²ˆí˜¸: {size_num})")
        loyalty_desc = LOYALTY_CLUSTER_DESCRIPTIONS.get(loyalty_num, f"ë¶„ì„ì¤‘ (êµ°ì§‘ë²ˆí˜¸: {loyalty_num})")
    except KeyError as e:
        st.error(f"ì˜¤ë¥˜: '{e}' ì»¬ëŸ¼ì„ 'final_master_data.csv'ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        st.stop()

    # --- 3ê°€ì§€ êµ°ì§‘ ì§„ë‹¨ ê²°ê³¼ ë³´ì—¬ì£¼ê¸° ---
    st.divider()
    st.header(f"'{selected}' 3ì°¨ì› ì…ì²´ ì§„ë‹¨")
    col1, col2, col3 = st.columns(3)
    with col1:
        st.subheader("â‘  ê³ ê° ìœ í˜• (WHO)")
        st.info(f"**{who_desc}**")
    with col2:
        st.subheader("â‘¡ ê°€ê²Œ ê²½ìŸë ¥ (SIZE)")
        st.success(f"**{size_desc}**")
    with col3:
        st.subheader("â‘¢ ê³ ê° ê´€ê³„ (LOYALTY)")
        st.warning(f"**{loyalty_desc}**")

    # --- Gemini AI ë¦¬í¬íŠ¸ ìƒì„± ---
    st.divider()
    st.header("ğŸ¤– AI ë¹„ë°€ìƒë‹´ì‚¬ì˜ ë§ì¶¤ ì „ëµ ë¦¬í¬íŠ¸")

    prompt = generate_prompt(
        store_name=store_data['ê°€ë§¹ì ëª…'],
        industry=store_data['ì—…ì¢…_ëŒ€ë¶„ë¥˜'],
        open_date=store_data['ê°œì„¤ì¼'],
        close_date=store_data['íì—…ì¼'],
        who_desc=who_desc,
        size_desc=size_desc,
        loyalty_desc=loyalty_desc
    )

    with st.expander("ìƒì„±ëœ Gemini í”„ë¡¬í”„íŠ¸ ë³´ê¸°"):
        st.text_area("í”„ë¡¬í”„íŠ¸ ë‚´ìš©", prompt, height=300)

    api_key = st.text_input("ğŸ”‘ Google API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", type="password")
    
    if st.button("ğŸš€ AI ì „ëµ ë¦¬í¬íŠ¸ ìƒì„±í•˜ê¸°"):
        if not api_key:
            st.error("Google API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        else:
            try:
                genai.configure(api_key=api_key)
                model = genai.GenerativeModel('gemini-2.5-flash')
                
                with st.spinner("Gemini 2.5 Flashê°€ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤..."):
                    response = model.generate_content(prompt)
                
                st.subheader("ğŸ’¡ ìµœì¢… ë¶„ì„ ê²°ê³¼")
                with st.chat_message("ai"):
                    st.markdown(response.text)
            except Exception as e:
                st.error(f"API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")

elif search:
    st.warning("í•´ë‹¹ ê°€ë§¹ì ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê²€ìƒ‰ì–´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")
